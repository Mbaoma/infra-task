name: 'Deploy Infra CI'

on:
    push:
        branches: [ main ]
    pull_request:
        branches:  [ main ]
        # paths:
        #     - '.'

env:
    FORCE_COLOR: 3
    AWS_REGION: us-east-1
    TF_KEY: my-terraform-state.tfstate


jobs:
    destroy_workspace:
      runs-on: ubuntu-latest
      name: Destroy terraform workspace
      steps:
        - name: Checkout
          uses: actions/checkout@v3

        - name: terraform destroy
          uses: dflook/terraform-destroy@v1
          with:
            path: my-terraform-config
            workspace: ${{ github.head_ref }}

    deploy:
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
          - name: Checkout Repo
            uses: actions/checkout@v2

          - name: Terraform Setup
            uses: hashicorp/setup-terraform@v1
            
          - name: Terraform Init
            run: terraform init
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              TF_ACTION_WORKING_DIR: '.'
              AWS_ACCESS_KEY_ID:  ${{ secrets.AWS_ACCESS_KEY_ID }}
              AWS_SECRET_ACCESS_KEY:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        
              
          - name: Terraform validate
            run: terraform validate

          - name: Terraform Apply
            run: terraform apply -auto-approve
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              TF_ACTION_WORKING_DIR: '.'
              AWS_ACCESS_KEY_ID:  ${{ secrets.AWS_ACCESS_KEY_ID }}
              AWS_SECRET_ACCESS_KEY:  ${{ secrets.AWS_SECRET_ACCESS_KEY }}

            # - uses: actions/checkout@v2
            # - uses: hashicorp/setup-terraform@v1

            # - name: Setup Terraform
            #   uses: hashicorp/setup-terraform@v1
            #   with:
            #     terraform_version: "1.1.0"

            # - name: Configure AWS credentials
            #   uses: aws-actions/configure-aws-credentials@v1
            #   with:
            #     aws-region: ${{ env.AWS_REGION }}
            #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
            #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

            # - name: Download Terraform state
            #   uses: aws-actions/amazon-s3-fetch-object@v1
            #   with:
            #     region: ${{ env.AWS_REGION }}
            #     bucket: ${{ secrets.TF_BUCKET }}
            #     key: ${{ env.TF_KEY }}
            #     path: ${GITHUB_WORKSPACE}/terraform/terraform.tfstate

            # - name: Terraform init
            #   run: terraform init -backend-config="bucket=${{ secrets.TF_BUCKET }}" -backend-config="key=${{ env.TF_KEY }}"

            # - name: Terraform Destroy
            #   env:
            #     AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
            #     AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            #   run: terraform destroy -auto-approve -input=false

            # - name: Terraform apply
            #   run: terraform apply -auto-approve

            